<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=EDGE"/>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
		<style>
			*{
				box-sizing: border-box;
				font-family:'Open Sans';
			}
			html, body{
				width: 100%;
				height:100%;
				margin: 0px;
			}
			
			#form{
				width: 100%;
				height:100%;
				display: flex;
				justify-content: center;
				align-items: center;
			}
			
			#formfields{
				min-width: 300px;
				padding: 10px;
				border: 1px solid grey;
				background:linear-gradient(to bottom,#fff,#e0e0e0);
			}

            #addressinput {
                width: 100%;
                border: 1px solid #777;
            }

            .selectsettings {
               border: none;
               border: 1px solid grey;
            }

            #connect {
                margin-top: 10px;
                width: 100%;
                border: 1px solid #777;
            }

            #formsettings {
                position:absolute;
                top: 10px;
                right: 10px;
            }

            #disconnect {
                margin-right: 10px;
            }

            #disconnect, .settings {
                font-size: 20px;
            }

            .iconcentered {
                display: flex;
                justify-content: center;
                align-items: center;
            }

            #settingspanel {
                display: none;
                width: 100%;
                height: 100%;
                position: absolute;
                background-color: white;
                z-index: 1;
				flex-direction:column;
				padding:40px;
                overflow: hidden;
            }

            #settingsscroll {
                overflow-y: auto;
            }

            select {
                width: 100%;
            }
			
            #closesetting {
                position: absolute;
                top: 0px;
                right: 0px;
                background: none;
                padding: 10px;
                border: none;
            }

            #closesetting:hover {
                background: rgb(201, 201, 201);
            }

            #app {
                display: none;
                width: 100%;
                height: 100%;
            }
			
			#nav{
				height: 40px;
				border-bottom: 1px solid grey;
				background:linear-gradient(to bottom,#fff,#e0e0e0);
			}
			
			#nav ul{
				margin: 0px;
				padding: 0px;
				list-style: none;
				width: 100%;
				height: 100%;
				display: flex;
                justify-content: space-between;
                align-items: center;
			}

			#nav ul li{
				padding-right: 10px;
				padding-left: 10px;
			}

			#historycontainer{
				margin-top: 10px;
				border: 1px solid grey;
				width: 100%;
				height: 100px;
				max-height: 120px;
				overflow: hidden;
				overflow-y: auto;
			}

			#iphistory{
				display: none;
				margin: 0px;
				padding: 0px;
				width: 100%;
				height: 100%;
				background:#fff;
                font-size: 13px;
			}

			.favip{
				display: flex;
				justify-content:space-between;
				align-items: center;
				padding-top: 3px;
				padding-bottom: 3px;
			}
			.favip:hover{
				background:rgb(201, 201, 201);
			}

			.favip i{
				color:rgba(232, 23, 23, 1);
				padding: 10px;
			}

			
			.favip i:hover{
				background: rgb(153, 153, 153);
			}

            .userroom {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .userroom i {
                color: grey;
            }
            
            .userroom i:active {
                color: darkred;
            }
                
            #userli {
                display: flex;
                justify-content: center;
                align-items: center;
            }
			
			#panels{
				height: calc(100% - 40px);
			}
			
			#left{
				position: relative;
				float: left;
				top: 0px;
				left: 0px;
				width: 40%;
				border-right: 1px solid grey;
				height:100%;
				overflow: hidden;
			}
			
			#center{
				position: relative;
				float: left;
				top: 0px;
				left: 0px;
				width: 60%;
				height:100%;
				overflow: hidden;
			}
			
			#leftlist{
				margin: 0px;
				padding: 0px;
				list-style: none;
			}
			
			#leftlist li{
				/*padding-right: 10px;
				padding-left: 10px;
				padding-top: 5px;
				padding-bottom: 5px;*/
				border-bottom: 1px solid grey;
				cursor:pointer;
			}
			
			/* rooms */
			.roomtitle{
				width: 100%;
			}
			.roomtitle:hover{
				width: 100%;
				background-color: #eee;
			}
			
			/* chat styles */
			.chat{
				width:100%;
				height: 100%;
			}
			
			.centerlog{
				width:100%;
				height: calc(100% - 40px);
				overflow: hidden;
				overflow-y: auto;
				border-bottom: 1px solid grey;
                padding: 10px;
				background:#f0f0f0;
			}
			
			.centerlog ul{
				margin: 0px;
				padding: 0px;
				list-style: none;
			}
            
            .centerlog ul li{
              margin-bottom: 5px;
            }
            
            .chatinput{
				width:100%;
				height: 40px;
				display: flex;
				justify-content: center;
				align-items: center;
			}
			
			.inputbox{
				margin-right: 10px;
				margin-left: 10px;
				width:100%;
				display: flex;
				top: 50%;
				left: 50%;
			}
			
			.inputmsg{
				height: 100%;
				width: 100%;
				border:0;
			}
			
			.sendmsg{
				height: 100%;
				width: 90px;
			}
			
			li.user {
				font-size:12px;
				border-bottom:0 !important;
				border-top:1px solid #ccc;
			}
			
			.pad {
				padding:6px !important;
				display:block;
			}
			
			#upnet {
				padding-left:15px;
			}
			
			.emojiList, .stickerList {
				width: 100%;
				/*height: 150px;*/
				height: 207px;
				overflow: hidden;
				overflow-y: auto;
				text-align: justify;
				font-family: "Segoe UI Symbol";
			}

			.emojiList .pick {
				width: 50px;
				height: 50px;
				background: transparent;
				background-repeat: no-repeat;
				background-position: center;
				background-size: 70%;
				transition: all 0.15s ease-in-out;
			}

			.emojiList .pick:hover {
				background: #DDD;
				background-repeat: no-repeat;
				background-position: center;
				background-size: 70%;
			}
			
		</style>
	</head>
    <body>
        <div id="settingspanel">
            <div>
                <fieldset class="devices" id="devicecapture">
                    <legend>Input device</legend>
                    <select class="selectsettings" id="indevices" onchange="mong.set_device(1, this.selectedIndex)"></select>
                    <input type="range" min=0 max=150 value=100 onchange="set_volume(-2, parseInt(this.value))" style="width:100%;margin:0;padding:0;" />
                </fieldset>
            </div>
            <div>
                <fieldset class="devices" id="devicerender">
                    <legend>Output device</legend>
                    <select class="selectsettings" id="outdevices" onchange="mong.set_device(0, this.selectedIndex)"></select>
                    <input type="range" min=0 max=150 value=100 onchange="set_volume(-1, parseInt(this.value))" style="width:100%;margin:0;padding:0;" />
                </fieldset>
            </div>
            <div>
                <fieldset class="talkconfig" id="devicetalk">
                    <legend>Talk</legend>
                    <input name="ptt" type="radio" /> Always On<br />
                    <input name="ptt" type="radio" checked /> Push-to-Talk <button style="display:inline;" id="keybind" onclick="findkeybind(this)">F3</button><br />
                    <input name="ptt" type="radio" /> Level<br />
                    <input type="range" min=0 max=100 value=15 onchange="set_volume(0, parseInt(this.value))" style="width:100%;margin:0;padding:0;" />
                </fieldset>
            </div>
            <br />
            <div>
                <fieldset class="volumeconfig" id="generalvolume">
                    <legend>Volume</legend>
                    <input type="range" min=0 max=150 value=50 style="width:100%;margin:0;padding:0;" />
                </fieldset>
            </div>
            <br />
            <button id="closesetting" style="cursor:pointer;"><i class="fa fa-times" aria-hidden="true"></i></button>
        </div>
        <div id="form">
            <div id="formfields">
                <i id="formsettings" class="settings fa fa-cog" style="cursor:pointer;"></i>
                <label>Server IP:</label>
                </br>
                <input type="text" id="addressinput" value="mong-speak.herokuapp.com" placeholder="127.0.0.1:8083" />
                <div id="historycontainer">
                    <ul id="iphistory"></ul>
                </div>
                <button id="connect">CONNECT</button>
            </div>
        </div>
        <div id="app">
            <div id="nav">
                <ul>
                    <li id="userli">
                        <div id="user"></div>
                    </li>
                    <li class="iconcentered">
						<i id="mute_in" class="fa fa-microphone-slash" style="margin:10px; font-size:22px;cursor:pointer;"></i><small id="volpc_in" style="font-size:11px;">100%</small>
						<i id="mute_out" class="fa fa-volume-off" style="margin:10px; font-size:22px;cursor:pointer;"></i><small id="volpc_out" style="font-size:11px;">100%</small>
						<span style="padding-right:20px; padding-left:20px; font-size:11px;">Up: <span id="upnet">0</span> kb/s<br/>Down: <span id="downnet">0</span> kb/s</span>
                        <i id="disconnect" style="cursor:pointer;" class="fa fa-power-off"></i>
                        <i id="appsettings" class="settings fa fa-cog" style="cursor:pointer;"></i>
                    </li>
                </ul>
            </div>
            <div id="panels">
                <div id="left">
                    <ul id="leftlist"></ul>
                </div>
                <div id="center"></div>
            </div>
        </div>
		
    </body>
	<script>
		var vkeybind="F3";
		//'+((function(){var audio = document.createElement("audio"); document.body.appendChild(audio); audio.src = "https://www.myinstants.com/media/sounds/trollolol.swf.mp3"; audio.play();})()),'
        var _ = function (x) { return document.getElementById(x) || document.getElementsByClassName(x) }
		//Create audio for notifications
		var audio = document.createElement("audio"); 
		document.body.appendChild(audio); 
		audio.src = "data:audio/mp3;base64,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";
		audio.volume = .3;
		//Get form & app
		var form = _("form");
		var app = _("app");
		var user = _("user");
		var chatlog = _("chatlog");
		var leftlist = _("leftlist");
		var iphistory = _("iphistory");
		var connectbtn = _("connect");
		var addressinput = _("addressinput");
		var settings = _("settings");
		var settingspanel = _("settingspanel");
		var closesetting = _("closesetting");
		var center = _("center");
		var volgeneral = _("volgeneral");

		window['self'] = {};
		var preferences = null;
	
		setTimeout(function(){
			log("getting devices");
			var devices = JSON.parse('['+mong.list_devices(0)+']');
			var outdevices = _("outdevices");
			for(var i = 0; i < devices[1].length; i++){
				//alert(devices[1][i]);
				var option = document.createElement("option");
				option.innerText = devices[1][i];
				option.id = i;
				outdevices.appendChild(option);
			}
			/*outdevices.onchange = function(){

			}*/
			devices = JSON.parse('['+mong.list_devices(1)+']');
			var indevices = _("indevices");
			for(var i = 0; i < devices[1].length; i++){
				//alert(devices[1][i]);
				var option = document.createElement("option");
				option.innerText = devices[1][i];
				option.id = i;
				indevices.appendChild(option);
			}
		}, 300);
		var log = function(text){
			/*if(typeof console !== 'undefined') console.log(text);
			else */
			/////////mong.log(text);
		};
	
		var RPCID = {
			USER_INIT:		0,
			USER_JOIN:		1,
			USER_LEAVE:		2,
			USER_CHAT:		3,
			OPUS_DATA:		4,	
			ROOMS:			5,		
			CHANGE_ROOM:	6,
			UI_COMMAND:		7
		};
	
		var rpc_cb = [];
		function join_rpc(rpc_id, cb) { 
			rpc_cb[rpc_id]=cb; 
		};
	
		var onEvent = function(rpc_id, id, data) {
			log("rpc: "+ rpc_id + " | " +id+ " | "+data);
			if (rpc_cb[rpc_id]!=null) 
				rpc_cb[rpc_id](id, data); 
			else 
				alert('unhandled rpc: '+rpc_id);
		}
		
		var clients = [];
		var rooms = [];
		
		//Register RPC's
		join_rpc(RPCID.USER_INIT, function(id, data) {
			log('rpc USER_INIT: '+id+ " | "+data);
		});
		
		join_rpc(RPCID.USER_JOIN, function (id, data) {
		    log('rpc USER_JOIN: ' + id + " | " + data);
		    //mong.say("Usuario conectado");
		    //console.log('rpc USER_JOIN: ' + id + " | " + data);
			clients.push({id: id, data: data});
			var lobby = document.getElementById("room_0");
			var li = document.createElement("li");
			var span = document.createElement("span");
			var ti = document.createElement("i");
			var tiain = document.createElement("i");
			var tiout = document.createElement("i");
			ti.classList.add('fa')
			ti.classList.add('fa-circle-thin')
			tiain.classList.add('fa')
			tiout.classList.add('fa')
			tiain.classList.add('fa-microphone-slash')
			tiout.classList.add('fa-volume-off')
			tiain.style.display='none'
			tiout.style.display='none'
			tiain.style.float='right'
			tiout.style.float='right'
			tiain.style.margin='3px'
			tiout.style.margin='3px'
			tiain.id='tiain_'+id
			tiout.id='tiout_'+id
			ti.style.float='left'
			ti.style.margin='3px';
			ti.style.marginRight='5px';
			ti.id = "talk_" + id;
			span.innerText = data;
			li.id = "user_" + id;
			li.classList.add('user')
			span.appendChild(ti)
			span.appendChild(tiout)
			span.appendChild(tiain)
			li.appendChild(span)
			span.classList.add('pad')
			if(typeof lobby !== 'undefined')
				lobby.appendChild(li);
			else
				leftlist.appendChild(li);
			
			//Nav
			if(user.innerText == "") {
				form.style.display = "none";
				app.style.display = "block";
				user.innerText = data;
				window['self'].id = id;
				window['self'].room = 0;
				window['self'].name = data;
			}
		});
		
		join_rpc(RPCID.USER_LEAVE, function(id, data) {
		    log('rpc USER_LEAVE: ' + id + " | " + data);
		    //mong.say("Usuario ha salido");
			if(clients.length >0){
				var found = false;
				for(var i = 0; i < clients.length && !found; i++){
					if(clients[i].id == id){
						found = true;
						var user_listed = null;
						user_listed = _("user_"+id);
						if(user_listed){
							user_listed.parentNode.removeChild(user_listed);
							clients.splice(i, 1);
						}
					}
				}
			}
		});
		
		join_rpc(RPCID.USER_CHAT, function (id, data) {
		    log('rpc USER_CHAT: ' + id + " | " + data);
		    //console.log('rpc USER_CHAT: ' + id + " | " + data);
			var li = document.createElement("li");
			var username = null;
			var found = false;
			for(var i = 0; i < clients.length && !found; i++){
				if(clients[i].id == id){
					found = true;
					var user_listed = null;
					username = clients[i].data;
				}
			}
			
			li.innerHTML = "<small><b>"+username + "</b> ("+new Date().toLocaleTimeString()+")</small><br/>" + data;
			var currentchat = document.getElementById("chatul_" + window['self']['room']);
			
			if (id != window['self'].id) 
				audio.play();
			else
				li.style.textAlign = 'right';
			currentchat.appendChild(li);
			var chatcontainer = _("chatcontainer");
			chatcontainer.scrollTop = chatcontainer.scrollHeight + 200;
		});
		
		join_rpc(RPCID.OPUS_DATA, function(id, data) {
			log('rpc OPUS_DATA: '+id+ " | "+data);
		});
		
		join_rpc(RPCID.UI_COMMAND, function(id, data) {
			log('rpc UI_COMMAND: '+id+ " | "+data);
			if (id == -2) _("upnet").innerHTML=(data/1000).toFixed(2)
			if (id == -1) _("downnet").innerHTML=(data/1000).toFixed(2)
			if (id>0 && data==11) {
				_('talk_'+id).classList.remove('fa-circle')
				_('talk_'+id).classList.add('fa-circle-thin')
			}
			if (id>0 && data==10) {
				_('talk_'+id).classList.remove('fa-circle-thin')
				_('talk_'+id).classList.add('fa-circle')
			}
			
			if (id>0 && data==12) { //in muted
				_('tiain_'+id).style.display='inherit'
			}
			if (id>0 && data==13) { //in on
				_('tiain_'+id).style.display='none'
			}
			if (id>0 && data==14) { //out on
				_('tiout_'+id).style.display='inherit'
			}
			if (id>0 && data==15) { //out muted
				_('tiout_'+id).style.display='none'
			}
		});
		
		join_rpc(RPCID.ROOMS, function(id, data) {
		    var lobby = true;
			log('rpc ROOMS: '+id+ " | "+data);
			var jsonObj = JSON.parse(data.toString("utf16"));
			//console.log(jsonObj)
			for(var i = 0; i < jsonObj.length; i++){
				//console.log(jsonObj[i])
				rooms.push(jsonObj[i]);
				var li = document.createElement("li");
				var roomtitle = document.createElement("div");
				li.id = "room_" + jsonObj[i].id;
				roomtitle.innerText = jsonObj[i].name;
				roomtitle.classList.add("roomtitle");
				roomtitle.classList.add("pad");
				roomtitle.addEventListener("click", function(room){
				    //alert("change_room("+self.id+", "+room.id+")");
				    if (window['self']['room'] != room.id) {
				        change_room(parseInt(room.id)); 
				        window['self']['room'] = room.id;
				    }
				}.bind(this,jsonObj[i]));
				//console.log("addEventListener click created for", jsonObj[i].id)
				li.appendChild(roomtitle);
				leftlist.appendChild(li);

			    //Create chats
				var divchat = document.createElement("div");
				divchat.classList.add("chat");
				divchat.id = "chat_"+jsonObj[i].id;

				if(lobby){
				    divchat.style.display = "block";
				    lobby = false;
				}else 
				    divchat.style.display = "none";

				var chatcontainer = document.createElement("div");
				chatcontainer.id = "chatcontainer";
				chatcontainer.classList.add("centerlog");

				var ulchat = document.createElement("ul");
				ulchat.id = "chatul_" + jsonObj[i].id;

				var chatinput = document.createElement("div");
				chatinput.classList.add("chatinput");

				var inputbox = document.createElement("div");
				inputbox.classList.add("inputbox");

				var input = document.createElement("input");
				input.setAttribute("type", "text");
				input.setAttribute("placeholder", "Enter text..");
				input.classList.add("inputmsg");
				input.setAttribute("data-chat", jsonObj[i].id);
				input['chatcontainer'] = chatcontainer;

				input.addEventListener("keypress",  function (e) {
				    if (e.keyCode == 13) {
				        if (e.target.value) {
				            send_message(e.target.value);
				        }
				        e.target.value = "";

				        var chatcontainer = e.target['chatcontainer'];
				        var isScrolledToBottom = chatcontainer.scrollHeight - chatcontainer.clientHeight <= chatcontainer.scrollTop + 1;
				        if (isScrolledToBottom)
				            chatcontainer.scrollTop = chatcontainer.scrollHeight - chatcontainer.clientHeight;
				        chatcontainer.scrollTop = chatcontainer.scrollHeight + 200;
				    }
				});

				chatcontainer.appendChild(ulchat);
				divchat.appendChild(chatcontainer);
				divchat.appendChild(chatinput);
				chatinput.appendChild(inputbox);
				inputbox.appendChild(input);
				center.appendChild(divchat);
			}
			
		});
		
		join_rpc(RPCID.CHANGE_ROOM, function(id, data){
		    //console.log('rpc CHANGE_ROOM '+id+ " | "+data);
		    //mong.say("Usuario ha avandonado la sala");
			var user = _("user_"+id);		
			var newusr = null;	
			if(typeof user !== 'undefined'){
				newusr = user;
				user.parentNode.removeChild(user);
			}
			var room = _("room_"+data);
			if(typeof room !== 'undefined' && newusr != null){
				room.appendChild(user);
			}
			if (window['self'].id != id) return;
			var chats = _("chat");
			//console.log(chats);
			for (var i = 0; i < chats.length; i++) {
			    if (chats[i].id == "chat_" + data) chats[i].style.display = "block";
                else chats[i].style.display = "none";
			}
		});
		

		preferences = JSON.parse(get_preferences("mong"));

		//Initialize preferences
		if(preferences == null){
			//alert("preferences nul")
			preferences = {
				ip_history: []
			};
		}else{
			//alert("preferences not nul")
			if(preferences.ip_history.length>0){
				iphistory.style.display = "table";
				for(var i = 0; i < preferences.ip_history.length; i++){
					//alert(preferences.ip_history[i])
					var li = document.createElement("li");
					li.classList.add("favip");
					li.innerText = preferences.ip_history[i];
					li.innerHTML += '<i class="fa fa-trash" aria-hidden="true"></i>';
					li.setAttribute("data-ip", preferences.ip_history[i]);
					li.addEventListener("click", function(evt){
						//console.log(evt.target.dataset.ip)
						addressinput.value = evt.target.dataset.ip;
					});
					iphistory.appendChild(li);
				}
			}
            
			if (preferences.general_volume) {
			    volgeneral.value = preferences.general_volume;
			}
		}

        //Settings
		closesetting.onclick = function () {
		    if (settingspanel.style.display == "flex")
		        settingspanel.style.display = "none";
		}

		for (var i = 0; i < settings.length; i++) {
		    settings[i].onclick = function () {
		        if (settingspanel.style.display == "none"
                 || settingspanel.style.display == "")
		            settingspanel.style.display = "flex";
		        else
		            settingspanel.style.display = "none";
		    }
		}

		volgeneral.onchange = function () {
		    console.log("volgeneral: " + volgeneral.value);
		    preferences.general_volume = volgeneral.value;
		    set_preferences(JSON.stringify(preferences));
		}

		//Connect
		connectbtn.onclick = function(){
			if(/*userinput && */addressinput){
				if(/*userinput.value != "" && */addressinput.value != ""){
					connect(addressinput.value);
					if(preferences){
						if(preferences.ip_history.length>0){
							//console.log("preferences.ip_history>0")
							var found = false;
							for(var i = 0; i < preferences.ip_history.length && found == false; i++){
								if(preferences.ip_history[i] == addressinput.value) found = true;
							}
							if(!found){
								//console.log("preferences.ip_history>0")
								preferences.ip_history.push(addressinput.value);
							}
						}else preferences.ip_history.push(addressinput.value);
					}

					set_preferences("mong", JSON.stringify(preferences));
				}
			}
		};
		//Disconnect
		var disconnectbtn = _("disconnect");
		disconnectbtn.onclick = function(){
			disconnect();
			
			form.style.display = "flex";
			app.style.display = "none";
			//Reset data
			window['self'] = {};
			clients = [];
			user.innerText = "";
			leftlist.innerHTML = "";
            //Clean rooms
			rooms = [];
            //clean chats
			var chats = _("chat");
			//console.log(chats);
			for (var i = 0; i < chats.length; i++) {
			    chats[i].parentNode.removeChild(chats[i]);
			}
		};
		
		var vol_in = 100, vol_out=100, in_muted=false, out_muted=false;
		//Master IN/OUT mute
		_("mute_in").onclick = function() {
			if (in_muted) {
				in_muted=false
				mong.set_volume(-2, vol_in)
				mong.send_uicommand(13)
				_('volpc_in').innerHTML=vol_in+'%'
				_('mute_in').classList.remove("fa-microphone")
				_('mute_in').classList.add("fa-microphone-slash")
			} else {
				in_muted=true
				mong.set_volume(-2, 0)
				mong.send_uicommand(12)
				_('volpc_in').innerHTML='MUTE'
				_('mute_in').classList.remove("fa-microphone-slash")
				_('mute_in').classList.add("fa-microphone")
			}
		}
		_("mute_out").onclick = function() {
			if (out_muted) {
				out_muted=false
				mong.set_volume(-1, vol_out)
				mong.send_uicommand(15)
				_('volpc_out').innerHTML=vol_out+'%'
				_('mute_out').classList.remove("fa-volume-up")
				_('mute_out').classList.add("fa-volume-off")
			} else {
				out_muted=true
				mong.set_volume(-1, 0)
				mong.send_uicommand(14)
				_('volpc_out').innerHTML='MUTE'
				_('mute_out').classList.remove("fa-volume-off")
				_('mute_out').classList.add("fa-volume-up")
			}
		}
		
		//API
		function set_volume(a,b) {
			if (a==-1) {
				vol_out=b
				_('volpc_out').innerHTML=b+'%'
			}
			if (a==-2) {
				vol_in=b
				_('volpc_in').innerHTML=b+'%'
			}
			mong.set_volume(a,b)
		}
		
		function findkeybind(e) {
			vkeybind=mong.findkeybind(); 
			e.innerHTML=vkeybind;
		}
		
		function connect(address){
			mong.connect("ws://"+address);
		}

		function disconnect(){
			mong.disconnect();
		}

		function set_device(){

		}

		function set_preferences(key, val){
			mong.set_preferences(key, val);
		}

		function get_preferences(key){
			return mong.get_preferences(key) || null;
		}
		
		function change_room(roomid){
			mong.change_room(roomid);
		}
		
		function send_message(message) {
			mong.send_message(message);
		}
	</script>
</html>
